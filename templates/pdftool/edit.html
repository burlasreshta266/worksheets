{% extends 'pdftool/layout.html' %}
{% load static %}
{% block body %}

<main class="container-fluid mt-3 main-bg">

<!-- Error messages -->
   {% if messages %}
        <div class="container mt-3">
        {% for message in messages %}
            <div class="alert 
                {% if message.tags == 'error' %}alert-danger
                {% else %}alert-{{ message.tags }}
                {% endif %}
                alert-dismissible fade show" role="alert">

                {{ message }}

                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
        </div>
    {% endif %}


    <div class="row g-3">

        <!-- PDF Preview -->
        <section class="col-lg-6 d-flex flex-column align-items-center">
            <div style="width:95%; height:70vh; border:1px solid #ccc;">
                <embed src="{{ pdf_url }}" type="application/pdf" width="100%" height="100%" />
            </div>
        </section>

        <!-- Controls -->
        <section class="col-lg-6 p-3">

            <!-- Title -->
            <div class="d-flex justify-content-center align-items-center mb-4">
                <form action="{% url 'edit_pdf_name' %}" method="POST" class="d-flex align-items-center">
                    {% csrf_token %}
                    <input type="text" value="{{ pdf_title }}" name="pdf_name" id="titleInput"
                           class="form-control text-center pdf-title-input" disabled>
                    <button id="editTitleBtn" type="button" class="btn btn-sm btn-thin">‚úèÔ∏è</button>
                    <button id="saveTitleBtn" type="submit" class="btn btn-sm btn-thin d-none">‚úîÔ∏è</button>
                </form>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5>Filters</h5>
                    <div class="d-flex flex-wrap justify-content-md-center">
                        <button class="btn btn-small btn-thin m-2 active">üö´</button>
                        <button class="btn btn-thin m-2">Greyscale</button>
                        <button class="btn btn-thin m-2">Light text</button>
                        <button class="btn btn-thin m-2">Defined</button>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row text-center mb-3">
                <div class="col-6">
                    <button class="btn btn-thin w-75">‚úÇÔ∏è Crop</button>
                </div>
                <div class="col-6">
                    <button class="btn btn-thin w-75">‚ûï Add pages</button>
                </div>
                <div class="col-6 mt-3">
                    <button id="openReorder" class="btn btn-thin w-75">üîÑ Reorder</button>
                </div>
                <div class="col-6 mt-3">
                    <button id="openDelete" class="btn btn-thin w-75">‚ùå Delete pages</button>
                </div>
            </div>

            <!-- Unified Thumbnail Panel -->
            <div id="thumbnailPanel" class="card mb-4" style="display:none;">
                <div class="card-body">

                    <h5 class="mb-3" id="panelTitle">Pages</h5>

                    <!-- Thumbnails -->
                    <div id="thumbnailGrid" class="row">
                        {% for page_number, img_path in thumbnails %}
                        <div class="col-6 col-md-4 text-center mb-4 draggable-item" 
                             draggable="true"
                             data-page="{{ page_number }}">
                            
                            <div class="thumb-container" style="width:100%;">
                                <div class="thumbnail-wrapper" style="border:1px solid #ccc; border-radius:4px; padding:6px;">
                                    <!-- DRAG HANDLE -->
                                    <div class="drag-handle"
                                        style="
                                        position:absolute;
                                        top:4px;
                                        left:4px;
                                        font-size:20px;
                                        cursor:grab;
                                        z-index:50;
                                        user-select:none;
                                     ">
                                        <span class="main-bg p-1 border">‚ò∞</span>
                                    </div>
                                    <img src="file://{{ img_path }}" 
                                         class="img-thumbnail thumb-img">
                                </div>

                                <!-- Delete checkbox (only shown in delete mode) -->
                                <div class="mt-2 delete-checkbox d-none">
                                    <input type="checkbox" value="{{ page_number }}" class="delete-page-checkbox">
                                    <span>Page {{ page_number }}</span>
                                </div>
                            </div>

                        </div>
                        {% endfor %}
                    </div>

                    <!-- Reorder controls -->
                    <div id="reorderControls" style="display:none;">
                        <button id="saveOrderBtn" class="btn btn-primary w-100">üíæ Save order</button>
                    </div>

                    <!-- Delete controls -->
                    <div id="deleteControls" style="display:none;">
                        <button id="deleteSelectedBtn" class="btn btn-danger w-100">‚ùå Delete selected</button>
                    </div>

                    <!-- Hidden forms -->
                    <form id="reorderForm" method="POST" action="{% url 'reorder_pages' %}" class="d-none">
                        {% csrf_token %}
                        <input type="hidden" name="order" id="orderInput">
                    </form>

                    <form id="deleteForm" method="POST" class="d-none">
                        {% csrf_token %}
                    </form>

                </div>
            </div>

            <!-- Bottom buttons -->
            <div class="row text-center p-2">
                <div class="col-6">
                    <form action="{% url 'delete_pdf' %}" method="POST" id="deletePdfForm">
                        {% csrf_token %}
                        <button class="btn btn-danger w-75">Delete PDF</button>
                    </form>
                </div>
                <div class="col-6">
                    <a href="{% url 'download_pdf' %}" class="btn btn-success w-75">Done</a>
                </div>
            </div>

        </section>
    </div>


<script src="{% static 'pdftool/edit_scripts.js' %}"></script>
</main>
{% endblock %}
