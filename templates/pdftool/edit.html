{% extends 'pdftool/layout.html' %}
{% load static %}
{% block body %}

<main class="container-fluid mt-3 main-bg">

    <!-- error messages -->
   {% if messages %}
        <div class="container mt-3">
        {% for message in messages %}
            <div class="alert 
                {% if message.tags == 'error' %}alert-danger
                {% else %}alert-{{ message.tags }}
                {% endif %}
                alert-dismissible fade show" role="alert">

                {{ message }}

                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
        </div>
    {% endif %}

    <div class="row g-3">

        <!-- PDF Preview (Large Screens) / Full Width (Small Screens) -->
        <section id="edit-pdf-preview-area" class="col-lg-6 d-flex flex-column align-items-center">
            <div class="pdf-preview-embed-container" style="width: 95%; height: 70vh; max-height: 800px; border: 1px solid #ccc;">
                <embed src="{{ pdf_url }}" type="application/pdf" width="100%" height="100%" />
            </div>
        </section>



        <!-- Edit Controls -->
        <section id="edit-controls-area" class="col-lg-6 p-3">

            <!-- PDF Title -->
            <div class="d-flex justify-content-center align-items-center mb-4">
                <form action="{% url 'edit_pdf_name' %}" method="POST" class="d-flex align-items-center">
                {% csrf_token %}
                    <input type="text" value="{{ pdf_title }}" name="pdf_name" id="titleInput" class="form-control text-center pdf-title-input" disabled>
                    <button id="editTitleBtn" type="button" class="btn btn-sm btn-thin">‚úèÔ∏è</button>
                    <button id="saveTitleBtn" type="submit" class="btn btn-sm btn-thin d-none">‚úîÔ∏è</button>
                </form>
            </div>


            <!-- Filters -->
            <div class="card mb-4 edit-card">
                <div class="card-body">
                    <h5 class="card-title">Filters</h5>
                    <div class="d-flex flex-wrap justify-content-md-center">
                        <button class="btn btn-small btn-thin m-2 active">üö´</button>
                        <button class="btn btn-thin m-2">Greyscale</button>
                        <button class="btn btn-thin m-2">Light text</button>
                        <button class="btn btn-thin m-2">Defined</button>
                    </div>
                </div>
            </div>


            <!-- Page Thumbnails -->
<div id="thumbnail-section" style="display: none;">
    <div class="card mb-4 edit-card">
        <div class="card-body">
            <h5 class="card-title">Pages</h5>

            <form id="multiDeleteForm" method="POST">
                {% csrf_token %}

                <div class="row">
                    {% for page_number, img_path in thumbnails %}
                    <div class="col-4 text-center mb-4">
                        <label for="page-{{ page_number }}" style="cursor: pointer; width: 100%; display:block;">
                            <div class="thumbnail-wrapper"
                                style="border: 1px solid #ccc; border-radius: 4px; padding: 6px;">
                                <img src="file://{{ img_path }}"
                                    class="img-thumbnail"
                                    style="height: 150px; object-fit: contain; width: 100%; background: #fafafa;">
                            </div>
                            <div class="mt-2">
                                <input type="checkbox"
                                    name="pages"
                                    value="{{ page_number }}"
                                    id="page-{{ page_number }}"
                                    style="cursor: pointer;">
                                Page {{ page_number }}
                            </div>
                        </label>
                    </div>
                    {% endfor %}
                </div>

                <button type="button"
                    id="confirmDeletePages"
                    class="btn btn-danger w-100 mt-3">
                    ‚ùå Confirm Delete Selected Pages
                </button>

            </form>
        </div>
    </div>
</div>

            <!-- Action buttons -->
            <div class="d-flex gap-4 justify-content-between m-1">
                <div class="row">
                    <div class="col-6 mb-3 text-center">
                        <button class="btn btn-thin w-75">‚úÇÔ∏è Crop</button>
                    </div>

                    <div class="col-6 mb-3 text-center">
                        <button class="btn btn-thin w-75">‚ûï Add pages</button>
                    </div>

                    <div class="col-6 mb-3 text-center">
                        <button class="btn btn-thin w-75 ">üîÑÔ∏è Reorder pages</button>
                    </div>

                    <div class="col-6 mb-3 text-center">
                        <button id="showDeleteUI" class="btn btn-thin w-75">‚ùå Delete pages</button>
                    </div>
               </div>
            </div>

            
            <div class="container-flex p-3">
                <div class="row">
                    <div class="col-6 text-center">
                        <!-- delete -->
                        <form action="{% url 'delete_pdf' %}" method="POST" id="deletePdfForm">
                            {% csrf_token %}
                            <button type="submit" id="deletePdfBtn" class="btn btn-danger btn-block">
                                üö´ Delete pdf
                            </button>
                        </form>
                    </div>

                    <div class="col-6 text-center">
                        <!-- done / download -->
                        <a href="{% url 'download_pdf' %}" id="download-btn" class="btn btn-success btn-block">‚úÖ Done</a>
                    </div>          
                </div>
            </div>
        </section>

    </div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const editTitleBtn = document.getElementById('editTitleBtn');
    const saveTitleBtn = document.getElementById('saveTitleBtn');
    const titleInput = document.getElementById('titleInput');

    // EDIT title
    editTitleBtn.addEventListener('click', function(event) {
        event.preventDefault();
        titleInput.disabled = false;
        titleInput.focus();
        editTitleBtn.classList.add("d-none");
        saveTitleBtn.classList.remove("d-none");
    });

    // DELETE pdf confirmation
    const deleteForm = document.getElementById('deletePdfForm');
    const deleteBtn  = document.getElementById('deletePdfBtn');

    deleteBtn.addEventListener('click', function(event) {
        event.preventDefault();  // prevent auto-submit

        const confirmed = confirm("Are you sure you want to delete this PDF? This action cannot be undone.");

        if (confirmed) {
            deleteForm.submit();
        }
    });

    // Delete selected pages confirmation
/* SHOW THUMBNAILS WHEN DELETE-PAGES CLICKED */
    const showDeleteUI = document.getElementById("showDeleteUI");
    const thumbnailSection = document.getElementById("thumbnail-section");

    showDeleteUI.addEventListener("click", function () {
        thumbnailSection.style.display = "block";

        // Scroll thumbnails into view
        thumbnailSection.scrollIntoView({ behavior: 'smooth' });
    });

    /* PURPLE SELECTION BORDER */
    document.querySelectorAll("input[name='pages']").forEach(cb => {
        cb.addEventListener("change", function () {
            const wrapper = cb.closest("label").querySelector(".thumbnail-wrapper");

            if (cb.checked) {
                wrapper.classList.add("selected");
            } else {
                wrapper.classList.remove("selected");
            }
        });
    });

    /* DELETE SELECTED PAGES */
    const deleteSelectedBtn = document.getElementById("confirmDeletePages");
    const form = document.getElementById("multiDeleteForm");

    deleteSelectedBtn.addEventListener("click", function () {
        const selected = [...document.querySelectorAll("input[name='pages']:checked")]
            .map(cb => cb.value);

        if (!selected.length) {
            alert("Please select at least one page.");
            return;
        }

        if (!confirm("Delete pages: " + selected.join(", ") + "?")) return;

        form.action = "/delete_pages/" + selected.join("-") + "/";
        form.submit();
    });
});
</script>


</main>
{% endblock %}